# Knowlens 部署指南

## 📋 概述

本文档详细说明如何使用 **ECS + Docker + Docker Compose** 的方式部署 Knowlens 项目到阿里云服务器。

**部署架构**：
- 前端：React 构建后的静态文件，由 Nginx 托管
- 后端：NestJS 应用，运行在 Docker 容器中
- 数据库：MongoDB（推荐使用 MongoDB Atlas 或阿里云 MongoDB）
- 缓存/队列：Redis（可在 ECS 上运行或使用云 Redis）
- 反向代理：Nginx（托管前端静态文件 + 反向代理后端 API）

---

## 🎯 前置准备

### 1. 服务器配置要求

**推荐配置（日活 1000）**：
- **CPU**：4核
- **内存**：8GB
- **系统盘**：40GB SSD
- **带宽**：5Mbps
- **操作系统**：Ubuntu 22.04 LTS

**最小配置（测试环境）**：
- **CPU**：2核
- **内存**：2GB
- **系统盘**：40GB SSD
- **带宽**：3Mbps
- **操作系统**：Ubuntu 22.04 LTS

### 2. 需要准备的内容

- [ ] 阿里云账号
- [ ] 域名（可选，建议有）
- [ ] MongoDB 数据库（MongoDB Atlas 或阿里云 MongoDB）
- [ ] Redis（可在 ECS 上安装或使用云 Redis）
- [ ] 阿里云 OSS Bucket
- [ ] 阿里云短信服务配置
- [ ] Moonshot API Key
- [ ] 科大讯飞 API Key

---

## 📦 第一步：购买和配置 ECS 服务器

### 1.1 购买 ECS 实例

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 进入 **云服务器 ECS** > **实例**
3. 点击 **创建实例**
4. 配置参数：
   - **付费模式**：包年包月（推荐）或按量付费
   - **地域和可用区**：选择离用户最近的地域
   - **实例规格**：选择 **ecs.c6.large**（2核4G）或 **ecs.c6.xlarge**（4核8G）
   - **镜像**：选择 **Ubuntu 22.04 64位**
   - **系统盘**：40GB 高效云盘
   - **网络**：选择专有网络 VPC
   - **公网 IP**：分配公网 IPv4 地址
   - **带宽**：选择 **按固定带宽**，5Mbps（测试环境可选 3Mbps）
   - **安全组**：选择默认安全组（后续需要配置）
   - **登录凭证**：选择 **自定义密码**，设置 root 密码（请妥善保管）
5. 点击 **确认订单** 并完成支付

### 1.2 配置安全组规则

1. 在 ECS 实例列表中，点击实例名称进入详情页
2. 点击 **安全组** > **配置规则**
3. 切换到 **入方向** 标签页，点击 **添加安全组规则**，添加以下规则：

#### 入方向规则

| 规则方向 | 授权策略 | 协议类型 | 端口范围 | 授权对象 | 描述 | 优先级 |
|---------|---------|---------|---------|---------|------|--------|
| 入方向 | 允许 | TCP | 22 | 你的IP/32 或 0.0.0.0/0 | SSH 远程连接 | 1 |
| 入方向 | 允许 | TCP | 80 | 0.0.0.0/0 | HTTP 访问 | 1 |
| 入方向 | 允许 | TCP | 443 | 0.0.0.0/0 | HTTPS 访问 | 1 |
| 入方向 | 允许 | TCP | 3000 | 127.0.0.1/32 | 后端服务（仅本机访问） | 1 |

**安全建议**：
- **SSH (22)**：建议将授权对象改为你的固定 IP（如 `123.45.67.89/32`），而不是 `0.0.0.0/0`，以提高安全性。如果 IP 经常变化，可暂时使用 `0.0.0.0/0`，但建议尽快限制。
- **端口 3000**：只允许本机访问（`127.0.0.1/32`），通过 Nginx 反向代理对外提供服务，确保后端服务不直接暴露在公网。
- **删除不需要的规则**：如果安全组中有 RDP (3389) 规则（Windows 远程桌面），请删除，因为 Linux 服务器不需要此端口。

4. 切换到 **出方向** 标签页，点击 **添加安全组规则**，添加以下规则：

#### 出方向规则

| 规则方向 | 授权策略 | 协议类型 | 端口范围 | 授权对象 | 描述 |
|---------|---------|---------|---------|---------|------|
| 出方向 | 允许 | 全部 | -1/-1 | 0.0.0.0/0 | 允许所有出站流量 |

**说明**：
- 出方向需要允许所有流量，因为服务器需要：
  - 访问外部 API（Moonshot AI、科大讯飞、阿里云服务）
  - 访问云数据库（MongoDB Atlas）
  - 系统更新（`apt-get update`）
  - Docker 镜像拉取
  - DNS 解析

### 1.3 连接服务器

使用 SSH 连接到服务器：

```bash
ssh root@<你的服务器公网IP>
```

输入之前设置的 root 密码。

---

## 🐳 第二步：安装 Docker 和 Docker Compose

### 2.1 更新系统包

```bash
apt-get update
apt-get upgrade -y
```

### 2.2 安装 Docker

```bash
# 安装必要的依赖
apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# 添加 Docker 官方 GPG 密钥
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 设置 Docker 仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker Engine
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 启动 Docker 服务
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
```

### 2.3 配置 Docker 镜像加速器（重要）

由于国内访问 Docker Hub 速度较慢，需要配置镜像加速器。

**推荐方案：使用阿里云专属加速器**（最稳定）

1. 登录 [阿里云容器镜像服务控制台](https://cr.console.aliyun.com/)
2. 点击左侧 **镜像加速器**
3. 复制你的专属加速器地址（格式类似：`https://xxxxx.mirror.aliyuncs.com`）
4. 在服务器上执行：

```bash
# 创建或编辑 Docker daemon 配置文件
mkdir -p /etc/docker
cat > /etc/docker/daemon.json << EOF
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://ccr.ccs.tencentyun.com"
  ],
  "userland-proxy": false,
  "iptables": true,
  "live-restore": true
}
EOF

# 重启 Docker 服务使配置生效
systemctl daemon-reload
systemctl restart docker

# 验证配置是否生效
docker info | grep -A 10 "Registry Mirrors"
```

### 2.4 安装 Docker Compose

Docker Compose 已经包含在 Docker Engine 中（作为插件），验证安装：

```bash
docker compose version
```

如果显示版本号，说明安装成功。

### 2.5 安装其他必要工具

```bash
# 安装 Git（用于拉取代码） ---- 废弃，通过本地上传代码
# apt-get install -y git

# 安装 Nginx（用于反向代理和静态文件托管）
apt-get install -y nginx

# 安装 yt-dlp（用于视频音频提取）
# 方式一：使用 pipx（推荐，适用于命令行工具）
apt-get install -y pipx
pipx ensurepath

# 使 PATH 立即生效（无需重新登录）
export PATH="$HOME/.local/bin:$PATH"

# 安装 yt-dlp
pipx install yt-dlp

# 验证安装
yt-dlp --version

# 方式二：直接下载二进制文件（更简单，无需 Python 环境）
# 如果方式一遇到 PATH 问题，可以使用此方式：
# curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
# chmod a+rx /usr/local/bin/yt-dlp
# yt-dlp --version

# 安装 FFmpeg（可选，用于音频格式转换）
apt-get install -y ffmpeg
```

---

## 📤 第三步：上传代码到服务器

### 3.1 在服务器上创建项目目录

```bash
# 在服务器上创建项目目录
mkdir -p /opt/knowlens
```

### 3.2 使用 rsync 上传代码

```bash
cd ~/knowlens
rsync -avz --exclude-from='.rsyncignore' . root@60.205.120.189:/opt/knowlens/
```

## 🐳 第四步：验证 Docker 配置文件

项目已经包含了所有必要的 Docker 配置文件，无需手动创建。请确认以下文件存在：

### 4.1 验证文件存在

```bash
cd /opt/knowlens

# 检查后端 Dockerfile
ls -la backend/Dockerfile

# 检查前端 Dockerfile
ls -la frontend/Dockerfile

# 检查前端 Nginx 配置
ls -la frontend/nginx.conf

# 检查 Docker Compose 配置
ls -la docker-compose.yml

# 检查 .dockerignore 文件
ls -la backend/.dockerignore
ls -la frontend/.dockerignore
```

如果所有文件都存在，可以继续下一步。如果缺少文件，请检查代码是否完整上传。

### 4.2 配置文件说明

项目包含以下 Docker 配置文件：

- **`backend/Dockerfile`**：后端服务 Docker 镜像构建文件
- **`frontend/Dockerfile`**：前端服务 Docker 镜像构建文件（多阶段构建）
- **`frontend/nginx.conf`**：前端 Nginx 配置文件（包含 API 反向代理）
- **`docker-compose.yml`**：Docker Compose 编排文件（包含 Redis、后端、前端服务）
- **`backend/.dockerignore`**：后端构建时忽略的文件列表
- **`frontend/.dockerignore`**：前端构建时忽略的文件列表

这些文件已经配置好，可以直接使用。

---

## 🚀 第五步：构建和启动服务

### 5.1 构建镜像

```bash
# 在服务器上执行，确保在项目根目录
cd /opt/knowlens

# 清理旧的构建缓存（可选，如果遇到缓存问题）
docker builder prune -f

# 构建镜像
docker compose build --no-cache
```

这个过程可能需要几分钟，取决于网络速度。


### 5.2 启动服务

```bash
docker compose up -d
```

`-d` 参数表示在后台运行。

### 5.3 查看服务状态

```bash
# 查看所有容器状态
docker compose ps

# 查看日志
docker compose logs -f

# 查看特定服务的日志
docker compose logs -f backend
docker compose logs -f frontend
```

### 5.4 验证服务

```bash
# 检查后端服务
curl http://localhost:3000/api

# 检查前端服务
curl http://localhost
```

如果返回内容，说明服务启动成功。

---

## 🌐 第七步：配置域名和 SSL 证书（可选）

### 7.1 配置域名解析

1. 在域名服务商处添加 A 记录：
   - **主机记录**：`@` 或 `www`
   - **记录类型**：A
   - **记录值**：你的服务器公网 IP
   - **TTL**：600

2. 如果需要 API 子域名，添加：
   - **主机记录**：`api`
   - **记录类型**：A
   - **记录值**：你的服务器公网 IP

### 7.2 安装 Certbot（Let's Encrypt SSL 证书）

```bash
# 安装 Certbot
apt-get install -y certbot python3-certbot-nginx

# 申请 SSL 证书（替换为你的域名）
certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 如果使用 API 子域名
certbot --nginx -d api.yourdomain.com
```

按照提示完成证书申请。

### 7.3 配置 Nginx（如果使用外部 Nginx）

如果不想使用 Docker 中的 Nginx，可以在服务器上安装 Nginx 并配置反向代理：

```bash
# 安装 Nginx
apt-get install -y nginx

# 创建 Nginx 配置文件
nano /etc/nginx/sites-available/knowlens
```

内容如下：

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    root /usr/share/nginx/html;
    index index.html;

    # 前端静态文件
    location / {
        proxy_pass http://localhost:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API 反向代理
    location /api {
        proxy_pass http://localhost:3000/api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：

```bash
ln -s /etc/nginx/sites-available/knowlens /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

---

## 🔧 第八步：配置数据库和 Redis

### 8.1 MongoDB 配置

**推荐方案：使用 MongoDB Atlas（免费）**

1. 访问 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. 注册账号并创建免费集群
3. 配置网络访问白名单（添加你的服务器 IP）
4. 创建数据库用户
5. 获取连接字符串，更新到 `backend/.env.production` 中的 `MONGODB_URI`

**备选方案：使用阿里云 MongoDB**

1. 在阿里云控制台购买 MongoDB 实例
2. 配置白名单和账号
3. 获取连接字符串，更新到环境变量

### 8.2 Redis 配置

**方案一：使用 Docker Compose 中的 Redis（推荐用于 MVP）**

已经在 `docker-compose.yml` 中配置，无需额外操作。

**方案二：使用阿里云 Redis**

1. 在阿里云控制台购买 Redis 实例
2. 获取连接地址和密码
3. 更新 `backend/.env.production` 中的 Redis 配置
4. 修改 `docker-compose.yml`，移除 Redis 服务，或修改后端连接配置

---

## 📝 第九步：常用操作命令

### 9.1 服务管理

```bash
# 启动服务
docker compose up -d

# 停止服务
docker compose down

# 重启服务
docker compose restart

# 重启特定服务
docker compose restart backend

# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f backend
```

### 9.2 更新代码

```bash
# 1. 拉取最新代码（如果使用 Git）
cd /opt/knowlens
git pull

# 2. 重新构建镜像
docker compose build

# 3. 重启服务
docker compose up -d
```

### 9.3 查看资源使用

```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 9.4 进入容器调试

```bash
# 进入后端容器
docker exec -it knowlens-backend sh

# 进入前端容器
docker exec -it knowlens-frontend sh
```

---

## 🔍 第十步：故障排查

### 10.1 服务无法启动

```bash
# 查看详细日志
docker compose logs backend
docker compose logs frontend

# 检查环境变量是否正确
docker exec knowlens-backend env | grep MONGODB_URI

# 检查端口是否被占用
netstat -tulpn | grep 3000
netstat -tulpn | grep 80
```

### 10.2 数据库连接失败

- 检查 MongoDB 连接字符串是否正确
- 检查 MongoDB 白名单是否包含服务器 IP
- 检查网络连接：`ping <mongodb-host>`

### 10.3 前端无法访问后端 API

- 检查 `VITE_API_BASE_URL` 配置是否正确
- 检查 Nginx 反向代理配置
- 检查后端服务是否正常运行：`curl http://localhost:3000/api`

### 10.4 查看容器日志

```bash
# 实时查看日志
docker compose logs -f backend

# 查看最近 100 行日志
docker compose logs --tail=100 backend
```

---

## 🔒 安全建议

1. **修改默认端口**：如果可能，修改 SSH 默认端口 22
2. **使用密钥登录**：配置 SSH 密钥登录，禁用密码登录
3. **定期更新系统**：`apt-get update && apt-get upgrade`
4. **配置防火墙**：使用 `ufw` 配置防火墙规则
5. **定期备份**：配置数据库和文件定期备份
6. **监控告警**：配置阿里云监控告警

---

## 📊 监控和维护

### 监控服务状态

```bash
# 设置定时任务检查服务状态
crontab -e

# 添加以下内容（每 5 分钟检查一次）
*/5 * * * * docker compose ps | grep -q "Up" || docker compose up -d
```

### 日志管理

```bash
# 配置日志轮转
nano /etc/logrotate.d/docker-containers
```

内容：

```
/var/lib/docker/containers/*/*.log {
    rotate 7
    daily
    compress
    size=10M
    missingok
    delaycompress
    copytruncate
}
```

---

## 💰 成本估算

| 服务 | 配置 | 月费用 |
|-----|-----|-------|
| ECS | 4核8G，5Mbps | ¥200-400 |
| MongoDB | MongoDB Atlas 免费版 | ¥0 |
| Redis | Docker 容器（ECS 上） | ¥0 |
| OSS | 50GB 存储 + 流量 | ¥20 |
| 短信服务 | 约 1000 条/月 | ¥50 |
| **小计** | | **¥270-470/月** |

---

## ✅ 部署检查清单

- [ ] ECS 服务器已购买并配置
- [ ] 安全组规则已配置
- [ ] Docker 和 Docker Compose 已安装
- [ ] 代码已上传到服务器
- [ ] 环境变量文件已创建并配置
- [ ] Dockerfile 和 docker-compose.yml 已创建
- [ ] 服务已构建并启动
- [ ] 数据库连接正常
- [ ] 前端可以访问
- [ ] 后端 API 可以访问
- [ ] SSL 证书已配置（如使用域名）
- [ ] 监控和日志已配置

---

## 📞 获取帮助

如果遇到问题，可以：

1. 查看容器日志：`docker compose logs -f`
2. 检查服务状态：`docker compose ps`
3. 查看系统资源：`docker stats`
4. 参考项目文档：`技术方案文档.md`

---

**部署完成后，访问你的域名或服务器 IP，即可使用 Knowlens 应用！**

