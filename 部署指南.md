# Knowlens éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•ä½¿ç”¨ **ECS + Docker + Docker Compose** çš„æ–¹å¼éƒ¨ç½² Knowlens é¡¹ç›®åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ã€‚

**éƒ¨ç½²æ¶æ„**ï¼š
- å‰ç«¯ï¼šReact æ„å»ºåçš„é™æ€æ–‡ä»¶ï¼Œç”± Nginx æ‰˜ç®¡
- åç«¯ï¼šNestJS åº”ç”¨ï¼Œè¿è¡Œåœ¨ Docker å®¹å™¨ä¸­
- æ•°æ®åº“ï¼šMongoDBï¼ˆæ¨èä½¿ç”¨ MongoDB Atlas æˆ–é˜¿é‡Œäº‘ MongoDBï¼‰
- ç¼“å­˜/é˜Ÿåˆ—ï¼šRedisï¼ˆå¯åœ¨ ECS ä¸Šè¿è¡Œæˆ–ä½¿ç”¨äº‘ Redisï¼‰
- åå‘ä»£ç†ï¼šNginxï¼ˆæ‰˜ç®¡å‰ç«¯é™æ€æ–‡ä»¶ + åå‘ä»£ç†åç«¯ APIï¼‰

---

## ğŸ¯ å‰ç½®å‡†å¤‡

### 1. æœåŠ¡å™¨é…ç½®è¦æ±‚

**æ¨èé…ç½®ï¼ˆæ—¥æ´» 1000ï¼‰**ï¼š
- **CPU**ï¼š4æ ¸
- **å†…å­˜**ï¼š8GB
- **ç³»ç»Ÿç›˜**ï¼š40GB SSD
- **å¸¦å®½**ï¼š5Mbps
- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 22.04 LTS

**æœ€å°é…ç½®ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰**ï¼š
- **CPU**ï¼š2æ ¸
- **å†…å­˜**ï¼š4GB
- **ç³»ç»Ÿç›˜**ï¼š40GB SSD
- **å¸¦å®½**ï¼š3Mbps
- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 22.04 LTS

### 2. éœ€è¦å‡†å¤‡çš„å†…å®¹

- [ ] é˜¿é‡Œäº‘è´¦å·
- [ ] åŸŸåï¼ˆå¯é€‰ï¼Œå»ºè®®æœ‰ï¼‰
- [ ] MongoDB æ•°æ®åº“ï¼ˆMongoDB Atlas æˆ–é˜¿é‡Œäº‘ MongoDBï¼‰
- [ ] Redisï¼ˆå¯åœ¨ ECS ä¸Šå®‰è£…æˆ–ä½¿ç”¨äº‘ Redisï¼‰
- [ ] é˜¿é‡Œäº‘ OSS Bucket
- [ ] é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡é…ç½®
- [ ] Moonshot API Key
- [ ] ç§‘å¤§è®¯é£ API Key

---

## ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šè´­ä¹°å’Œé…ç½® ECS æœåŠ¡å™¨

### 1.1 è´­ä¹° ECS å®ä¾‹

1. ç™»å½• [é˜¿é‡Œäº‘æ§åˆ¶å°](https://ecs.console.aliyun.com/)
2. è¿›å…¥ **äº‘æœåŠ¡å™¨ ECS** > **å®ä¾‹**
3. ç‚¹å‡» **åˆ›å»ºå®ä¾‹**
4. é…ç½®å‚æ•°ï¼š
   - **ä»˜è´¹æ¨¡å¼**ï¼šåŒ…å¹´åŒ…æœˆï¼ˆæ¨èï¼‰æˆ–æŒ‰é‡ä»˜è´¹
   - **åœ°åŸŸå’Œå¯ç”¨åŒº**ï¼šé€‰æ‹©ç¦»ç”¨æˆ·æœ€è¿‘çš„åœ°åŸŸ
   - **å®ä¾‹è§„æ ¼**ï¼šé€‰æ‹© **ecs.c6.large**ï¼ˆ2æ ¸4Gï¼‰æˆ– **ecs.c6.xlarge**ï¼ˆ4æ ¸8Gï¼‰
   - **é•œåƒ**ï¼šé€‰æ‹© **Ubuntu 22.04 64ä½**
   - **ç³»ç»Ÿç›˜**ï¼š40GB é«˜æ•ˆäº‘ç›˜
   - **ç½‘ç»œ**ï¼šé€‰æ‹©ä¸“æœ‰ç½‘ç»œ VPC
   - **å…¬ç½‘ IP**ï¼šåˆ†é…å…¬ç½‘ IPv4 åœ°å€
   - **å¸¦å®½**ï¼šé€‰æ‹© **æŒ‰å›ºå®šå¸¦å®½**ï¼Œ5Mbpsï¼ˆæµ‹è¯•ç¯å¢ƒå¯é€‰ 3Mbpsï¼‰
   - **å®‰å…¨ç»„**ï¼šé€‰æ‹©é»˜è®¤å®‰å…¨ç»„ï¼ˆåç»­éœ€è¦é…ç½®ï¼‰
   - **ç™»å½•å‡­è¯**ï¼šé€‰æ‹© **è‡ªå®šä¹‰å¯†ç **ï¼Œè®¾ç½® root å¯†ç ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰
5. ç‚¹å‡» **ç¡®è®¤è®¢å•** å¹¶å®Œæˆæ”¯ä»˜

### 1.2 é…ç½®å®‰å…¨ç»„è§„åˆ™

1. åœ¨ ECS å®ä¾‹åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»å®ä¾‹åç§°è¿›å…¥è¯¦æƒ…é¡µ
2. ç‚¹å‡» **å®‰å…¨ç»„** > **é…ç½®è§„åˆ™**
3. ç‚¹å‡» **æ·»åŠ å®‰å…¨ç»„è§„åˆ™**ï¼Œæ·»åŠ ä»¥ä¸‹è§„åˆ™ï¼š

| è§„åˆ™æ–¹å‘ | æˆæƒç­–ç•¥ | åè®®ç±»å‹ | ç«¯å£èŒƒå›´ | æˆæƒå¯¹è±¡ | æè¿° |
|---------|---------|---------|---------|---------|------|
| å…¥æ–¹å‘ | å…è®¸ | TCP | 22 | 0.0.0.0/0 | SSH è¿œç¨‹è¿æ¥ |
| å…¥æ–¹å‘ | å…è®¸ | TCP | 80 | 0.0.0.0/0 | HTTP è®¿é—® |
| å…¥æ–¹å‘ | å…è®¸ | TCP | 443 | 0.0.0.0/0 | HTTPS è®¿é—® |
| å…¥æ–¹å‘ | å…è®¸ | TCP | 3000 | 127.0.0.1/32 | åç«¯æœåŠ¡ï¼ˆä»…æœ¬æœºè®¿é—®ï¼‰ |

**æ³¨æ„**ï¼šç«¯å£ 3000 åªå…è®¸æœ¬æœºè®¿é—®ï¼Œé€šè¿‡ Nginx åå‘ä»£ç†å¯¹å¤–æä¾›æœåŠ¡ã€‚

### 1.3 è¿æ¥æœåŠ¡å™¨

ä½¿ç”¨ SSH è¿æ¥åˆ°æœåŠ¡å™¨ï¼š

```bash
ssh root@<ä½ çš„æœåŠ¡å™¨å…¬ç½‘IP>
```

è¾“å…¥ä¹‹å‰è®¾ç½®çš„ root å¯†ç ã€‚

---

## ğŸ³ ç¬¬äºŒæ­¥ï¼šå®‰è£… Docker å’Œ Docker Compose

### 2.1 æ›´æ–°ç³»ç»ŸåŒ…

```bash
apt-get update
apt-get upgrade -y
```

### 2.2 å®‰è£… Docker

```bash
# å®‰è£…å¿…è¦çš„ä¾èµ–
apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# è®¾ç½® Docker ä»“åº“
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# å®‰è£… Docker Engine
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# å¯åŠ¨ Docker æœåŠ¡
systemctl start docker
systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
```

### 2.3 å®‰è£… Docker Compose

Docker Compose å·²ç»åŒ…å«åœ¨ Docker Engine ä¸­ï¼ˆä½œä¸ºæ’ä»¶ï¼‰ï¼ŒéªŒè¯å®‰è£…ï¼š

```bash
docker compose version
```

å¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·ï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚

### 2.4 å®‰è£…å…¶ä»–å¿…è¦å·¥å…·

```bash
# å®‰è£… Gitï¼ˆç”¨äºæ‹‰å–ä»£ç ï¼‰
apt-get install -y git

# å®‰è£… Nginxï¼ˆç”¨äºåå‘ä»£ç†å’Œé™æ€æ–‡ä»¶æ‰˜ç®¡ï¼‰
apt-get install -y nginx

# å®‰è£… yt-dlpï¼ˆç”¨äºè§†é¢‘éŸ³é¢‘æå–ï¼‰
apt-get install -y python3 python3-pip
pip3 install yt-dlp

# å®‰è£… FFmpegï¼ˆå¯é€‰ï¼Œç”¨äºéŸ³é¢‘æ ¼å¼è½¬æ¢ï¼‰
apt-get install -y ffmpeg
```

---

## ğŸ“¤ ç¬¬ä¸‰æ­¥ï¼šä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨

### 3.1 æ–¹å¼ä¸€ï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰

å¦‚æœä½ çš„ä»£ç å·²ç»æ¨é€åˆ° GitHub/GitLab ç­‰ Git ä»“åº“ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/knowlens
cd /opt/knowlens

# å…‹éš†ä»£ç ï¼ˆæ›¿æ¢ä¸ºä½ çš„ä»“åº“åœ°å€ï¼‰
git clone https://github.com/your-username/knowlens.git .

# æˆ–è€…å¦‚æœä»“åº“æ˜¯ç§æœ‰çš„ï¼Œä½¿ç”¨ SSHï¼š
# git clone git@github.com:your-username/knowlens.git .
```

### 3.2 æ–¹å¼äºŒï¼šä½¿ç”¨ SCP ä¸Šä¼ 

å¦‚æœä»£ç åœ¨æœ¬åœ°ï¼Œä½¿ç”¨ SCP ä¸Šä¼ ï¼š

```bash
# åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œï¼ˆæ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨ IP å’Œè·¯å¾„ï¼‰
scp -r /path/to/knowlens root@<æœåŠ¡å™¨IP>:/opt/knowlens
```

### 3.3 æ–¹å¼ä¸‰ï¼šä½¿ç”¨ rsyncï¼ˆæ¨èç”¨äºåç»­æ›´æ–°ï¼‰

```bash
# åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œ
rsync -avz --exclude 'node_modules' --exclude '.git' \
  /path/to/knowlens/ root@<æœåŠ¡å™¨IP>:/opt/knowlens/
```

---

## ğŸ” ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

ç”±äº `.env` æ–‡ä»¶æ²¡æœ‰ä¸Šä¼ åˆ° Gitï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨åˆ›å»ºã€‚

### 4.1 åˆ›å»ºåç«¯ç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
cd /opt/knowlens/backend
nano .env.production
```

å°†é…ç½®æ–‡ä»¶å†…å®¹å¤åˆ¶è¿›å»ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼š
ä¿å­˜æ–‡ä»¶ï¼šæŒ‰ `Ctrl + X`ï¼Œç„¶åæŒ‰ `Y`ï¼Œæœ€åæŒ‰ `Enter`ã€‚

### 4.2 åˆ›å»ºå‰ç«¯ç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
cd /opt/knowlens/frontend
nano .env.production
```

å°†å‰ç«¯é…ç½®æ–‡ä»¶å†…å®¹å¤åˆ¶è¿›å»ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼š
ä¿å­˜æ–‡ä»¶ã€‚

---

## ğŸ³ ç¬¬äº”æ­¥ï¼šéªŒè¯ Docker é…ç½®æ–‡ä»¶

é¡¹ç›®å·²ç»åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„ Docker é…ç½®æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºã€‚è¯·ç¡®è®¤ä»¥ä¸‹æ–‡ä»¶å­˜åœ¨ï¼š

### 5.1 éªŒè¯æ–‡ä»¶å­˜åœ¨

```bash
cd /opt/knowlens

# æ£€æŸ¥åç«¯ Dockerfile
ls -la backend/Dockerfile

# æ£€æŸ¥å‰ç«¯ Dockerfile
ls -la frontend/Dockerfile

# æ£€æŸ¥å‰ç«¯ Nginx é…ç½®
ls -la frontend/nginx.conf

# æ£€æŸ¥ Docker Compose é…ç½®
ls -la docker-compose.yml

# æ£€æŸ¥ .dockerignore æ–‡ä»¶
ls -la backend/.dockerignore
ls -la frontend/.dockerignore
```

å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨ï¼Œå¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ã€‚å¦‚æœç¼ºå°‘æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦å®Œæ•´ä¸Šä¼ ã€‚

### 5.2 é…ç½®æ–‡ä»¶è¯´æ˜

é¡¹ç›®åŒ…å«ä»¥ä¸‹ Docker é…ç½®æ–‡ä»¶ï¼š

- **`backend/Dockerfile`**ï¼šåç«¯æœåŠ¡ Docker é•œåƒæ„å»ºæ–‡ä»¶
- **`frontend/Dockerfile`**ï¼šå‰ç«¯æœåŠ¡ Docker é•œåƒæ„å»ºæ–‡ä»¶ï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰
- **`frontend/nginx.conf`**ï¼šå‰ç«¯ Nginx é…ç½®æ–‡ä»¶ï¼ˆåŒ…å« API åå‘ä»£ç†ï¼‰
- **`docker-compose.yml`**ï¼šDocker Compose ç¼–æ’æ–‡ä»¶ï¼ˆåŒ…å« Redisã€åç«¯ã€å‰ç«¯æœåŠ¡ï¼‰
- **`backend/.dockerignore`**ï¼šåç«¯æ„å»ºæ—¶å¿½ç•¥çš„æ–‡ä»¶åˆ—è¡¨
- **`frontend/.dockerignore`**ï¼šå‰ç«¯æ„å»ºæ—¶å¿½ç•¥çš„æ–‡ä»¶åˆ—è¡¨

è¿™äº›æ–‡ä»¶å·²ç»é…ç½®å¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

---

## ğŸš€ ç¬¬å…­æ­¥ï¼šæ„å»ºå’Œå¯åŠ¨æœåŠ¡

### 6.1 æ„å»º Docker é•œåƒ

```bash
cd /opt/knowlens
docker compose build
```

è¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œå–å†³äºç½‘ç»œé€Ÿåº¦ã€‚

### 6.2 å¯åŠ¨æœåŠ¡

```bash
docker compose up -d
```

`-d` å‚æ•°è¡¨ç¤ºåœ¨åå°è¿è¡Œã€‚

### 6.3 æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æ—¥å¿—
docker compose logs -f backend
docker compose logs -f frontend
```

### 6.4 éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:3000/api

# æ£€æŸ¥å‰ç«¯æœåŠ¡
curl http://localhost
```

å¦‚æœè¿”å›å†…å®¹ï¼Œè¯´æ˜æœåŠ¡å¯åŠ¨æˆåŠŸã€‚

---

## ğŸŒ ç¬¬ä¸ƒæ­¥ï¼šé…ç½®åŸŸåå’Œ SSL è¯ä¹¦ï¼ˆå¯é€‰ï¼‰

### 7.1 é…ç½®åŸŸåè§£æ

1. åœ¨åŸŸåæœåŠ¡å•†å¤„æ·»åŠ  A è®°å½•ï¼š
   - **ä¸»æœºè®°å½•**ï¼š`@` æˆ– `www`
   - **è®°å½•ç±»å‹**ï¼šA
   - **è®°å½•å€¼**ï¼šä½ çš„æœåŠ¡å™¨å…¬ç½‘ IP
   - **TTL**ï¼š600

2. å¦‚æœéœ€è¦ API å­åŸŸåï¼Œæ·»åŠ ï¼š
   - **ä¸»æœºè®°å½•**ï¼š`api`
   - **è®°å½•ç±»å‹**ï¼šA
   - **è®°å½•å€¼**ï¼šä½ çš„æœåŠ¡å™¨å…¬ç½‘ IP

### 7.2 å®‰è£… Certbotï¼ˆLet's Encrypt SSL è¯ä¹¦ï¼‰

```bash
# å®‰è£… Certbot
apt-get install -y certbot python3-certbot-nginx

# ç”³è¯· SSL è¯ä¹¦ï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåï¼‰
certbot --nginx -d yourdomain.com -d www.yourdomain.com

# å¦‚æœä½¿ç”¨ API å­åŸŸå
certbot --nginx -d api.yourdomain.com
```

æŒ‰ç…§æç¤ºå®Œæˆè¯ä¹¦ç”³è¯·ã€‚

### 7.3 é…ç½® Nginxï¼ˆå¦‚æœä½¿ç”¨å¤–éƒ¨ Nginxï¼‰

å¦‚æœä¸æƒ³ä½¿ç”¨ Docker ä¸­çš„ Nginxï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Nginx å¹¶é…ç½®åå‘ä»£ç†ï¼š

```bash
# å®‰è£… Nginx
apt-get install -y nginx

# åˆ›å»º Nginx é…ç½®æ–‡ä»¶
nano /etc/nginx/sites-available/knowlens
```

å†…å®¹å¦‚ä¸‹ï¼š

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    root /usr/share/nginx/html;
    index index.html;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        proxy_pass http://localhost:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API åå‘ä»£ç†
    location /api {
        proxy_pass http://localhost:3000/api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

å¯ç”¨é…ç½®ï¼š

```bash
ln -s /etc/nginx/sites-available/knowlens /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx
```

---

## ğŸ”§ ç¬¬å…«æ­¥ï¼šé…ç½®æ•°æ®åº“å’Œ Redis

### 8.1 MongoDB é…ç½®

**æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨ MongoDB Atlasï¼ˆå…è´¹ï¼‰**

1. è®¿é—® [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. æ³¨å†Œè´¦å·å¹¶åˆ›å»ºå…è´¹é›†ç¾¤
3. é…ç½®ç½‘ç»œè®¿é—®ç™½åå•ï¼ˆæ·»åŠ ä½ çš„æœåŠ¡å™¨ IPï¼‰
4. åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
5. è·å–è¿æ¥å­—ç¬¦ä¸²ï¼Œæ›´æ–°åˆ° `backend/.env.production` ä¸­çš„ `MONGODB_URI`

**å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨é˜¿é‡Œäº‘ MongoDB**

1. åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°è´­ä¹° MongoDB å®ä¾‹
2. é…ç½®ç™½åå•å’Œè´¦å·
3. è·å–è¿æ¥å­—ç¬¦ä¸²ï¼Œæ›´æ–°åˆ°ç¯å¢ƒå˜é‡

### 8.2 Redis é…ç½®

**æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ Docker Compose ä¸­çš„ Redisï¼ˆæ¨èç”¨äº MVPï¼‰**

å·²ç»åœ¨ `docker-compose.yml` ä¸­é…ç½®ï¼Œæ— éœ€é¢å¤–æ“ä½œã€‚

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨é˜¿é‡Œäº‘ Redis**

1. åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°è´­ä¹° Redis å®ä¾‹
2. è·å–è¿æ¥åœ°å€å’Œå¯†ç 
3. æ›´æ–° `backend/.env.production` ä¸­çš„ Redis é…ç½®
4. ä¿®æ”¹ `docker-compose.yml`ï¼Œç§»é™¤ Redis æœåŠ¡ï¼Œæˆ–ä¿®æ”¹åç«¯è¿æ¥é…ç½®

---

## ğŸ“ ç¬¬ä¹æ­¥ï¼šå¸¸ç”¨æ“ä½œå‘½ä»¤

### 9.1 æœåŠ¡ç®¡ç†

```bash
# å¯åŠ¨æœåŠ¡
docker compose up -d

# åœæ­¢æœåŠ¡
docker compose down

# é‡å¯æœåŠ¡
docker compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker compose restart backend

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker compose logs -f backend
```

### 9.2 æ›´æ–°ä»£ç 

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨ Gitï¼‰
cd /opt/knowlens
git pull

# 2. é‡æ–°æ„å»ºé•œåƒ
docker compose build

# 3. é‡å¯æœåŠ¡
docker compose up -d
```

### 9.3 æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

### 9.4 è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker exec -it knowlens-backend sh

# è¿›å…¥å‰ç«¯å®¹å™¨
docker exec -it knowlens-frontend sh
```

---

## ğŸ” ç¬¬åæ­¥ï¼šæ•…éšœæ’æŸ¥

### 10.1 æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs backend
docker compose logs frontend

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®
docker exec knowlens-backend env | grep MONGODB_URI

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 3000
netstat -tulpn | grep 80
```

### 10.2 æ•°æ®åº“è¿æ¥å¤±è´¥

- æ£€æŸ¥ MongoDB è¿æ¥å­—ç¬¦ä¸²æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ MongoDB ç™½åå•æ˜¯å¦åŒ…å«æœåŠ¡å™¨ IP
- æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š`ping <mongodb-host>`

### 10.3 å‰ç«¯æ— æ³•è®¿é—®åç«¯ API

- æ£€æŸ¥ `VITE_API_BASE_URL` é…ç½®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ Nginx åå‘ä»£ç†é…ç½®
- æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š`curl http://localhost:3000/api`

### 10.4 æŸ¥çœ‹å®¹å™¨æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker compose logs -f backend

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker compose logs --tail=100 backend
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤ç«¯å£**ï¼šå¦‚æœå¯èƒ½ï¼Œä¿®æ”¹ SSH é»˜è®¤ç«¯å£ 22
2. **ä½¿ç”¨å¯†é’¥ç™»å½•**ï¼šé…ç½® SSH å¯†é’¥ç™»å½•ï¼Œç¦ç”¨å¯†ç ç™»å½•
3. **å®šæœŸæ›´æ–°ç³»ç»Ÿ**ï¼š`apt-get update && apt-get upgrade`
4. **é…ç½®é˜²ç«å¢™**ï¼šä½¿ç”¨ `ufw` é…ç½®é˜²ç«å¢™è§„åˆ™
5. **å®šæœŸå¤‡ä»½**ï¼šé…ç½®æ•°æ®åº“å’Œæ–‡ä»¶å®šæœŸå¤‡ä»½
6. **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®é˜¿é‡Œäº‘ç›‘æ§å‘Šè­¦

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### ç›‘æ§æœåŠ¡çŠ¶æ€

```bash
# è®¾ç½®å®šæ—¶ä»»åŠ¡æ£€æŸ¥æœåŠ¡çŠ¶æ€
crontab -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
*/5 * * * * docker compose ps | grep -q "Up" || docker compose up -d
```

### æ—¥å¿—ç®¡ç†

```bash
# é…ç½®æ—¥å¿—è½®è½¬
nano /etc/logrotate.d/docker-containers
```

å†…å®¹ï¼š

```
/var/lib/docker/containers/*/*.log {
    rotate 7
    daily
    compress
    size=10M
    missingok
    delaycompress
    copytruncate
}
```

---

## ğŸ’° æˆæœ¬ä¼°ç®—

| æœåŠ¡ | é…ç½® | æœˆè´¹ç”¨ |
|-----|-----|-------|
| ECS | 4æ ¸8Gï¼Œ5Mbps | Â¥200-400 |
| MongoDB | MongoDB Atlas å…è´¹ç‰ˆ | Â¥0 |
| Redis | Docker å®¹å™¨ï¼ˆECS ä¸Šï¼‰ | Â¥0 |
| OSS | 50GB å­˜å‚¨ + æµé‡ | Â¥20 |
| çŸ­ä¿¡æœåŠ¡ | çº¦ 1000 æ¡/æœˆ | Â¥50 |
| **å°è®¡** | | **Â¥270-470/æœˆ** |

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ECS æœåŠ¡å™¨å·²è´­ä¹°å¹¶é…ç½®
- [ ] å®‰å…¨ç»„è§„åˆ™å·²é…ç½®
- [ ] Docker å’Œ Docker Compose å·²å®‰è£…
- [ ] ä»£ç å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] ç¯å¢ƒå˜é‡æ–‡ä»¶å·²åˆ›å»ºå¹¶é…ç½®
- [ ] Dockerfile å’Œ docker-compose.yml å·²åˆ›å»º
- [ ] æœåŠ¡å·²æ„å»ºå¹¶å¯åŠ¨
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] å‰ç«¯å¯ä»¥è®¿é—®
- [ ] åç«¯ API å¯ä»¥è®¿é—®
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¦‚ä½¿ç”¨åŸŸåï¼‰
- [ ] ç›‘æ§å’Œæ—¥å¿—å·²é…ç½®

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`docker compose logs -f`
2. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`docker compose ps`
3. æŸ¥çœ‹ç³»ç»Ÿèµ„æºï¼š`docker stats`
4. å‚è€ƒé¡¹ç›®æ–‡æ¡£ï¼š`æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£.md`

---

**éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®ä½ çš„åŸŸåæˆ–æœåŠ¡å™¨ IPï¼Œå³å¯ä½¿ç”¨ Knowlens åº”ç”¨ï¼**

