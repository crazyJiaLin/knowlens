# Knowlens 项目启动指南

## 📋 前置条件

### 1. 必需软件安装

#### Node.js 和 npm
- **Node.js**: 版本 >= 20.4.0（推荐 20.11+）
- **npm**: 版本 >= 9.7.2
- 验证安装：
  ```bash
  node -v
  npm -v
  ```

#### MongoDB
- **本地安装**（推荐开发环境）：
  - macOS: `brew install mongodb-community`
  - 启动服务: `brew services start mongodb-community`
  - 或手动启动: `mongod --config /usr/local/etc/mongod.conf`
  
- **或使用 MongoDB Atlas**（云数据库，免费版可用）：
  - 访问: https://www.mongodb.com/cloud/atlas
  - 创建免费集群
  - 获取连接字符串

#### Redis（可选，第一阶段暂不需要）
- **本地安装**：
  - macOS: `brew install redis`
  - 启动服务: `brew services start redis`
  - 或手动启动: `redis-server`

---

## 🔧 环境变量配置

### 2. 前端环境变量配置

在 `frontend/` 目录下创建 `.env.development` 文件：

```env
# API 基础路径
VITE_API_BASE_URL=http://localhost:3000/api

# 应用配置
VITE_APP_TITLE=Knowlens
VITE_APP_VERSION=1.0.0
```

**注意**：如果使用生产环境，创建 `.env.production` 文件并修改 `VITE_API_BASE_URL` 为生产环境地址。

### 3. 后端环境变量配置

在 `backend/` 目录下创建 `.env.development` 文件：

```env
# 应用配置
NODE_ENV=development
PORT=3000
APP_NAME=Knowlens

# MongoDB 数据库
# 本地 MongoDB
MONGODB_URI=mongodb://localhost:27017/knowlens
# 或使用 MongoDB Atlas（替换为你的连接字符串）
# MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/knowlens?retryWrites=true&w=majority

# Redis（第一阶段暂不需要，但需要配置）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# JWT 认证（必须修改为安全的密钥）
JWT_SECRET=your-jwt-secret-key-at-least-32-characters-please-change-this
JWT_EXPIRES_IN=7d

# 阿里云 OSS（第一阶段暂不需要，但需要配置占位符）
ALIYUN_ACCESS_KEY_ID=your-access-key-id
ALIYUN_ACCESS_KEY_SECRET=your-access-key-secret
ALIYUN_OSS_REGION=oss-cn-hangzhou
ALIYUN_OSS_BUCKET=knowlens
ALIYUN_OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com

# 阿里云短信服务（第一阶段暂不需要，但需要配置占位符）
ALIYUN_SMS_ACCESS_KEY_ID=your-access-key-id
ALIYUN_SMS_ACCESS_KEY_SECRET=your-access-key-secret
ALIYUN_SMS_SIGN_NAME=Knowlens
ALIYUN_SMS_TEMPLATE_CODE=SMS_xxxxxx
ALIYUN_SMS_REGION=cn-hangzhou

# Moonshot Kimi API（第一阶段暂不需要，但需要配置占位符）
MOONSHOT_API_KEY=your-moonshot-api-key
MOONSHOT_BASE_URL=https://api.moonshot.cn/v1
MOONSHOT_MODEL=moonshot-v1-k2

# 科大讯飞语音识别（第一阶段暂不需要，但需要配置占位符）
XFYUN_APP_ID=your-app-id
XFYUN_SECRET_KEY=your-secret-key

# BullMQ 任务队列配置（第一阶段暂不需要）
QUEUE_REDIS_HOST=localhost
QUEUE_REDIS_PORT=6379
QUEUE_VIDEO_CONCURRENCY=3
QUEUE_PDF_CONCURRENCY=5
QUEUE_KNOWLEDGE_CONCURRENCY=2

# 日志配置
LOG_LEVEL=debug
LOG_DIR=./logs

# CORS 配置
CORS_ORIGIN=http://localhost:5173
```

**重要提示**：
- ⚠️ **JWT_SECRET** 必须修改为至少 32 个字符的随机字符串
- ⚠️ 第一阶段（项目初始化）只需要配置 `MONGODB_URI` 和 `JWT_SECRET`，其他配置可以暂时使用占位符
- ⚠️ 如果使用 MongoDB Atlas，需要将连接字符串中的 `username`、`password` 和 `cluster` 替换为实际值

---

## 🚀 启动步骤

### 4. 安装依赖

#### 前端依赖
```bash
cd frontend
npm install
```

#### 后端依赖
```bash
cd backend
npm install
```

### 5. 启动 MongoDB（如果使用本地 MongoDB）

```bash
# macOS 使用 Homebrew
brew services start mongodb-community

# 或手动启动
mongod --config /usr/local/etc/mongod.conf

# 验证 MongoDB 是否运行
mongosh
# 如果成功连接，会显示 MongoDB shell 提示符
```

### 6. 启动 Redis（可选，第一阶段暂不需要）

```bash
# macOS 使用 Homebrew
brew services start redis

# 验证 Redis 是否运行
redis-cli ping
# 应该返回 PONG
```

### 7. 启动后端服务

```bash
cd backend
npm run start:dev
```

**预期输出**：
```
应用运行在: http://localhost:3000
API 文档: http://localhost:3000/api/docs
```

**验证后端是否启动成功**：
- 访问 http://localhost:3000/api/docs 查看 Swagger API 文档
- 访问 http://localhost:3000/api 查看 API 根路径

### 8. 启动前端服务

**新开一个终端窗口**，然后：

```bash
cd frontend
npm run dev
```

**预期输出**：
```
  VITE v7.2.4  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
```

**验证前端是否启动成功**：
- 访问 http://localhost:5173 查看前端页面

---

## ✅ 启动验证清单

- [ ] MongoDB 已启动并可以连接
- [ ] 后端 `.env.development` 文件已创建并配置
- [ ] 前端 `.env.development` 文件已创建并配置
- [ ] 后端服务运行在 http://localhost:3000
- [ ] 后端 Swagger 文档可访问 http://localhost:3000/api/docs
- [ ] 前端服务运行在 http://localhost:5173
- [ ] 前端页面可以正常打开

---

## 🔍 常见问题排查

### 问题 1: MongoDB 连接失败

**错误信息**：`MongooseServerSelectionError: connect ECONNREFUSED`

**解决方案**：
1. 确认 MongoDB 服务已启动：`brew services list | grep mongodb`
2. 检查 MongoDB 端口是否被占用：`lsof -i :27017`
3. 确认 `.env.development` 中的 `MONGODB_URI` 配置正确

### 问题 2: 后端启动失败

**错误信息**：`Error: listen EADDRINUSE: address already in use :::3000`

**解决方案**：
1. 检查端口 3000 是否被占用：`lsof -i :3000`
2. 修改 `.env.development` 中的 `PORT` 为其他端口（如 3001）
3. 同时修改前端的 `VITE_API_BASE_URL` 为对应端口

### 问题 3: 前端无法连接后端

**错误信息**：`Network Error` 或 `CORS Error`

**解决方案**：
1. 确认后端服务已启动
2. 检查前端 `.env.development` 中的 `VITE_API_BASE_URL` 是否正确
3. 检查后端 `.env.development` 中的 `CORS_ORIGIN` 是否包含前端地址

### 问题 4: 环境变量不生效

**解决方案**：
1. 确认环境变量文件名称正确（`.env.development`）
2. 确认文件在正确的目录（`frontend/` 或 `backend/`）
3. 重启开发服务器（环境变量只在启动时加载）

---

## 📝 注意事项

1. **开发环境**：使用 `.env.development` 文件
2. **生产环境**：使用 `.env.production` 文件
3. **敏感信息**：不要将 `.env` 文件提交到 Git（已在 `.gitignore` 中配置）
4. **端口冲突**：如果 3000 或 5173 端口被占用，可以修改环境变量中的端口配置
5. **数据库**：第一阶段只需要 MongoDB，Redis 可以稍后配置

---

## 🎯 下一步

项目启动成功后，可以：
1. 访问 http://localhost:5173 查看前端页面
2. 访问 http://localhost:3000/api/docs 查看 API 文档
3. 开始进行第一阶段的后续开发工作（数据库 Schema、用户认证等）

---

## 📚 相关文档

- 技术方案文档：`技术方案文档.md`
- 需求文档：`需求文档.md`
- Nest.js 文档：https://docs.nestjs.com/
- Vite 文档：https://vitejs.dev/

