# 认证系统配置说明

## 📋 概述

用户认证系统已完成，包括：
- 短信验证码登录
- JWT Token 认证（存储在 HttpOnly Cookie 中）
- 自动登录弹窗（401 时）
- 用户状态管理

## 🔧 需要配置的环境变量

### 后端环境变量（`.env.development` 或 `.env.production`）

在 `backend/.env.development` 或 `backend/.env.production` 文件中配置以下变量：

```env
# JWT 配置
JWT_SECRET=your-jwt-secret-key-at-least-32-characters-please-change-this
JWT_EXPIRES_IN=7d

# 阿里云短信服务配置
ALIYUN_SMS_ACCESS_KEY_ID=your-access-key-id
ALIYUN_SMS_ACCESS_KEY_SECRET=your-access-key-secret
ALIYUN_SMS_SIGN_NAME=your-sign-name
ALIYUN_SMS_TEMPLATE_CODE=SMS_123456789
ALIYUN_SMS_REGION=cn-hangzhou

# CORS 配置
CORS_ORIGIN=http://localhost:5173
```

### 前端环境变量（`.env.development` 或 `.env.production`）

在 `frontend/.env.development` 或 `frontend/.env.production` 文件中配置：

```env
VITE_API_BASE_URL=http://localhost:3000/api
```

## 🔑 如何获取阿里云短信服务配置

### 1. 获取 AccessKey ID 和 AccessKey Secret

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 点击右上角头像 → **AccessKey 管理**
3. 创建 AccessKey（如果还没有）
4. 复制 **AccessKey ID** 和 **AccessKey Secret**

⚠️ **安全提示**：
- 不要将 AccessKey 提交到 Git 仓库
- 生产环境建议使用 RAM 子账号，并只授予短信服务权限
- 定期轮换 AccessKey

### 2. 创建短信签名

1. 登录 [阿里云短信服务控制台](https://dysms.console.aliyun.com/)
2. 进入 **国内消息** → **签名管理**
3. 点击 **添加签名**
4. 填写签名信息：
   - **签名名称**：例如 "知识图谱"、"Knowlens" 等
   - **签名来源**：选择对应的来源（网站、APP、公众号等）
   - **证明文件**：上传相关证明文件
5. 等待审核通过（通常 1-2 个工作日）
6. 审核通过后，复制 **签名名称**，作为 `ALIYUN_SMS_SIGN_NAME` 的值

### 3. 创建短信模板

1. 在短信服务控制台，进入 **国内消息** → **模板管理**
2. 点击 **添加模板**
3. 填写模板信息：
   - **模板名称**：例如 "验证码模板"
   - **模板类型**：选择 **验证码**
   - **模板内容**：例如 `您的验证码是${code}，5分钟内有效，请勿泄露。`
   - **申请说明**：说明模板用途
4. 等待审核通过
5. 审核通过后，复制 **模板 CODE**（格式如 `SMS_123456789`），作为 `ALIYUN_SMS_TEMPLATE_CODE` 的值

### 4. 模板变量说明

在 `auth.service.ts` 中，验证码通过 `TemplateParam` 传递：

```typescript
TemplateParam: JSON.stringify({ code })
```

如果你的模板变量名不是 `code`，需要修改 `auth.service.ts` 中的对应代码。

## 🧪 开发环境测试（无需配置短信服务）

在开发环境中，如果未配置阿里云短信服务，系统会：
1. 在控制台打印验证码（方便测试）
2. 验证码仍然会保存到数据库，可以正常验证

**查看验证码**：
```bash
# 启动后端服务后，发送验证码时会在控制台看到：
[开发环境] 验证码: 123456 (手机号: 13800138000)
```

## 📝 环境变量文件示例

### `backend/.env.development`

```env
# 应用配置
PORT=3000
NODE_ENV=development
APP_NAME=Knowlens

# MongoDB
MONGODB_URI=mongodb://localhost:27017/knowlens

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# JWT
JWT_SECRET=dev-jwt-secret-key-change-in-production
JWT_EXPIRES_IN=7d

# 阿里云短信（开发环境可以不配置，会在控制台打印验证码）
# ALIYUN_SMS_ACCESS_KEY_ID=
# ALIYUN_SMS_ACCESS_KEY_SECRET=
# ALIYUN_SMS_SIGN_NAME=
# ALIYUN_SMS_TEMPLATE_CODE=
# ALIYUN_SMS_REGION=cn-hangzhou

# CORS
CORS_ORIGIN=http://localhost:5173
```

### `backend/.env.production`

```env
# 应用配置
PORT=3000
NODE_ENV=production
APP_NAME=Knowlens

# MongoDB
MONGODB_URI=mongodb://your-mongodb-uri

# Redis
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password
REDIS_DB=0

# JWT（生产环境必须使用强密钥）
JWT_SECRET=your-strong-jwt-secret-key-at-least-32-characters
JWT_EXPIRES_IN=7d

# 阿里云短信（生产环境必须配置）
ALIYUN_SMS_ACCESS_KEY_ID=your-access-key-id
ALIYUN_SMS_ACCESS_KEY_SECRET=your-access-key-secret
ALIYUN_SMS_SIGN_NAME=your-sign-name
ALIYUN_SMS_TEMPLATE_CODE=SMS_123456789
ALIYUN_SMS_REGION=cn-hangzhou

# CORS
CORS_ORIGIN=https://your-domain.com
```

### `frontend/.env.development`

```env
VITE_API_BASE_URL=http://localhost:3000/api
```

### `frontend/.env.production`

```env
VITE_API_BASE_URL=https://api.your-domain.com/api
```

## ✅ 验证配置

### 1. 检查后端配置

启动后端服务后，访问 Swagger 文档：
```
http://localhost:3000/api/docs
```

在 Swagger 中测试：
- `POST /api/auth/send-code` - 发送验证码
- `POST /api/auth/verify` - 验证码登录
- `POST /api/auth/logout` - 退出登录

### 2. 检查前端配置

启动前端服务后：
1. 打开浏览器开发者工具 → Network
2. 点击"获取验证码"按钮
3. 检查请求是否发送到正确的 API 地址
4. 检查响应是否正常

### 3. 测试完整流程

1. **发送验证码**：
   - 输入手机号（11位，1开头）
   - 点击"获取验证码"
   - 查看控制台或手机短信获取验证码

2. **登录**：
   - 输入验证码
   - 点击"登录"
   - 检查是否成功登录（用户信息保存到 localStorage）

3. **验证认证**：
   - 访问需要认证的 API
   - 检查 Cookie 中是否有 `token`
   - 检查请求头是否携带 Cookie

## 🔒 安全建议

1. **JWT Secret**：
   - 生产环境必须使用强随机密钥（至少32字符）
   - 可以使用 `openssl rand -base64 32` 生成

2. **Cookie 安全**：
   - 生产环境确保使用 HTTPS
   - Cookie 设置为 `HttpOnly`（已配置）
   - Cookie 设置为 `Secure`（生产环境自动启用）

3. **短信服务**：
   - 使用 RAM 子账号，最小权限原则
   - 设置短信发送频率限制（已在代码中实现：1分钟1次）
   - 验证码有效期5分钟（已在代码中实现）

4. **环境变量**：
   - 不要将 `.env` 文件提交到 Git
   - 使用环境变量管理工具（如 AWS Secrets Manager、阿里云 KMS）

## 📚 相关文档

- [阿里云短信服务文档](https://help.aliyun.com/product/44282.html)
- [NestJS JWT 文档](https://docs.nestjs.com/security/authentication)
- [Passport JWT 策略](http://www.passportjs.org/packages/passport-jwt/)

